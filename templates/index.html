<!DOCTYPE html>
<html lang="en">
    {% load my_tag my_filter%}
    <head>
        <title>{% block title %}无名小站{% endblock %}</title>
        <link rel="stylesheet" href="/static/my/css/base.css">
        {% block CSS %}
            <link rel="stylesheet" href="/static/my/css/index.css">
        {% endblock %}
        <link rel="stylesheet" href="/static/my/css/reset.css">
        <link rel="stylesheet" href="/static/fontawesome-free-5/css/all.min.css">
        <link rel="stylesheet" href="/static/elementui/theme-chalk/index.css">
        <script src="/static/vue/vue.js"></script>
        <script src="/static/jquery/jquery.min.js"></script>
        <script src="/static/elementui/index.js"></script>
    </head>
    <body>
        <div id="app">
            <link rel="stylesheet" :href="'/static/my/css/theme/' + theme +'.css'">
            <el-scrollbar ref="scrollbar" style="height: 100vh">
            <nav class="nav_bg">
                <div class="left" id="dynamic_nav">
                    {% dynamic_navigation request %}
                    <div class="search">
                        <input type="text" @keydown.enter="search" v-model="search_key" class="search_box" placeholder="搜索你想要的内容">
                        <button @click="search"><i class="fa fa-search"></i></button>
                    </div>
                </div>

                <div class="right">
                    <img
                        v-show="theme === 'light'"
                        src="/static/my/img/nav/light.svg"
                        @click="setTheme('dark')"
                        alt="">
                    <img
                        v-show="theme === 'dark'"
                        src="/static/my/img/nav/dark.svg"
                        @click="setTheme('light')"
                        alt="">
                    {% if request.user.username %}
                        <el-dropdown>
                            <span class="el-dropdown-link">
                              {{ request.user.username }}
                              <i class="el-icon-arrow-down el-icon--right"></i>
                            </span>
                            <el-dropdown-menu slot="dropdown">
                              <el-dropdown-item><a href="/backend/">个人中心</a></el-dropdown-item>
                              <el-dropdown-item><a href="/backend/edit_avatar/">修改头像</a></el-dropdown-item>
                              <el-dropdown-item><a href="/backend/add_article/">发布文章</a></el-dropdown-item>
                              <el-dropdown-item><a href="/admin/">后台管理</a></el-dropdown-item>
                              <el-dropdown-item><a href="/logout/">注销退出</a></el-dropdown-item>
                            </el-dropdown-menu>
                        </el-dropdown>
                    {% else %}
                        <a href="/login">登录</a>
                        <a href="/sign">注册</a>
                    {% endif %}
                    <!--/el-dropdown-->
                </div>
            </nav>
            {% block banner %}
                {% banner 'index'%}
            {% endblock %}
            <main>
                {% csrf_token %}
                {% block main %}
                    <div class="main">
                        <div class="left">
                            <div class="boutique_card card">
                                <div class="title">
                                    <h2>精选文档</h2>
                                    <div class="switch_article_category">
                                        <span :active = "this_category === 'qianduan'" @click = 'switch_article_category("qianduan")'>前端</span>
                                        <span :active = "this_category === 'houduan'" @click = 'switch_article_category("houduan")'>后端</span>
                                    </div>
                                </div>
                                <div class="body">
                                    <ul v-show = "this_category === 'qianduan'" class = 'qianduan'>
                                        {% for frontend in frontend_list %}
                                            <li>
                                                <div class="left">
                                                    <div>
                                                        <a href="/article/{{ frontend.nid }}/" ><img src="{{ frontend.cover.url.url }}" alt=""></a>
                                                    </div>
                                                </div>
                                                <div class="right">
                                                    <h2><a href="/article/{{ frontend.nid }}/" target="_blank">{{ frontend.title }}</a></h2>
                                                    <p>{{ frontend.abstract }}</p>
                                                    <span>{{ frontend.create_date|date_humaniz}}</span>
                                                </div>
                                            </li>
                                        {% endfor %}
                                    </ul>

                                    <ul v-show = "this_category === 'houduan'" class = 'houduan'>
                                        {% for backend in backend_list %}
                                            <li>
                                                <div class="left">
                                                    <div>
                                                        <a href="/article/{{ backend.nid }}/"  ><img src="{{ backend.cover.url.url }}" alt=""></a>
                                                    </div>
                                                </div>
                                                <div class="right">
                                                    <h2><a href="/article/{{ backend.nid }}/" target="_blank">{{ backend.title }}</a></h2>
                                                    <p>{{ backend.abstract }}</p>
                                                    <span>{{ backend.create_date|date_humaniz }}</span>
                                                </div>
                                            </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>

                            <div class="hotList card">
                                <div class="title">
                                    <h2 id="pos">今日新闻</h2>
                                    <div>
                                        <a href="/news/">查看更多</a>
                                    </div>
                                </div>
                                <div class="body">
                                    <div v-for="item in news_list" :key="item.index">
                                        <span class="index">[[ item.index ]]</span>
                                            <a :href="item.link" target="_blank">[[ item.title ]]</a>
                                        <span class="num">[[ item.hotValue ]]</span>
                                    </div>
                                </div>
                            </div>

                            <div class="all_article card">
                                <div class="title">
                                    <h2>博客文章</h2>
                                </div>
                                <div class="body">
                                {% if request.user.is_superuser %}
                                            <el-dialog
                                              title="修改文章封面"
                                              :visible.sync="edit_cover_dialog"
                                              width="20%">
                                                <div class="dialog_content">
                                                    <div>
                                                        <label for="">文章封面</label>
                                                          <el-select v-model="edit_cover.nid" placeholder="请选择文章封面">
                                                              {% for cover in cover_list %}
                                                                  <el-option
                                                                      label="{{ cover.url.url }}"
                                                                      value="{{ cover.nid }}">
                                                                  <img src="{{ cover.url.url }}">
                                                                </el-option>
                                                              {% endfor %}
                                                          </el-select>
                                                    </div>
                                                </div>
                                              <span slot="footer" class="dialog-footer">
                                                <el-button @click="edit_cover_dialog = false">取 消</el-button>
                                                <el-button type="primary" @click="edit_cover_method(edit_cover.aid)">确 定</el-button>
                                              </span>
                                            </el-dialog>
                                        {% endif %}
                                    <ul class="active_content">
                                        {% for article in article_list %}
                                            <li>
                                            {% if article.category %}
                                                <div class="category_flag" len="{{ article.get_category_display|length }}" type="{{ article.get_category_display }}">
                                                    {{ article.get_category_display }}
                                                </div>
                                            {% endif %}
                                                <div class="left">
                                                    <div>
                                                        <el-image
                                                            scroll-container=".el-scrollbar__wrap"
                                                            @contextmenu.ctrl.prevent="show_edit_cover('{{ article.nid }}', '{{ article.cover.nid }}')"
                                                            src="{{ article.cover.url.url }}" lazy alt="">
                                                            <div slot="placeholder" class="image-slot">
                                                            </div>加载中<spam class="dot">...</spam>
                                                        </el-image>
                                                    </div>
                                                </div>
                                                <div class="right">
                                                    <h2>
                                                        <a href="/article/{{ article.nid }}/">{{ article.title }}</a>
                                                    </h2>
                                                    <p>
                                                        {{ article.abstract }}
                                                    </p>
                                                    <div class="article_info">
                                                        <span>
                                                            <i class="far fa-clock"></i>{{ article.create_date|date_humaniz}}
                                                        </span>
                                                        <span>
                                                            <i class="fas fa-thumbs-up"></i>{{ article.digg_count }}
                                                        </span>
                                                        <span>
                                                            <i class="far fa-eye"></i>{{ article.look_count }}
                                                        </span>
                                                        <span>
                                                            <i class="fas fa-comment"></i>{{ article.comment_count }}
                                                        </span>
                                                        <span>
                                                            <i class="fas fa-star-half-alt"></i>{{ article.collects_count }}
                                                        </span>
                                                        <a href="/article/{{ article.nid }}/" target="_blank">查看详情</a>
                                                    </div>
                                                </div>
                                            </li>
                                        {% endfor %}
                                    </ul>
                                     <lu class="pager">
                                         {{ pager.page_html|safe }}
                                     </lu>
                                </div>
                            </div>
                        </div>

                        <div class="right">
                            {% if advert_list.count %}
                                <div class="advertisement card">
                                <div class="title">
                                    <h2>独家广告</h2>
                                    <div>
                                        <a href="">申请</a>
                                    </div>
                                </div>
                                <div class="body">
                                    <el-carousel :interval="5000" trigger="click" class="adv_img_list" height="200px">
                                    {% for advert in advert_list|generate_advert %}
                                        <el-carousel-item>
                                                <a title="{{ advert.title }}" href="{{ advert.href }}" target="_blank">
                                                    <img src="{{ advert.url }}">
                                                </a>
                                        </el-carousel-item>
                                    {% endfor %}
                                    </el-carousel>
                                </div>
                            </div>
                            {% endif %}
                            <div class="tags card">
                                <div class="title">
                                    <h2>标签云</h2>
                                </div>
                                <div class="body">
                                    <ul>
                                        <li>python</li>
                                        <li>python</li>
                                        <li>python</li>
                                        <li>python</li>
                                        <li>python</li>
                                        <li>python</li>
                                        <li>python</li>
                                        <li>python</li>
                                        <li>python</li>
                                        <li>python</li>
                                        <li>python</li>
                                        <li>python</li>
                                        <li>python</li>
                                        <li>python</li>
                                        <li>python</li>

                                    </ul>
                                </div>
                            </div>

                            <div class="site_info card">
                                <div class="title">
                                    <h2>站点信息</h2>
                                </div>
                                <div class="body">
                                    <div class="item">
                                        <b>建设站时间:</b>
                                        <span>2021年12月29日</span>
                                    </div>
                                    <div class="item">
                                        <b>网站程序:</b>
                                        <span>Django+Vue.js</span>
                                    </div>
                                    <div class="item">
                                        <b>前端文章:</b>
                                        <span>{% calculation_category_count 1 %}</span>
                                    </div>
                                    <div class="item">
                                        <b>后端文章:</b>
                                        <span>{% calculation_category_count 2 %}</span>
                                    </div>
                                    <div class="item">
                                        <b>网站空间:</b>
                                        <span>2021年12月29日</span>
                                    </div>
                                    <div class="item">
                                        <b>订阅内容:</b>
                                        <div class="images">
                                            <div class="qq"><img src="http://127.0.0.1:8000/media/advert/IMG_5497.JPG" alt="我的qq">我的QQ</div>
                                            <div class="qq"><img src="http://127.0.0.1:8000/media/advert/IMG_5497.JPG" alt="我的qq">我的微信</div>
                                        </div>

                                    </div>
                                </div>

                            </div>

                            <div class="feedback card">
                                <div class="title">
                                    <h2>意见反馈</h2>
                                </div>
                                <div class="body">
                                    <el-input
                                        id="feedback__email"
                                        placeholder="用于接收反馈的邮箱"
                                        v-model="feedback.email">
                                    </el-input>
                                    <el-input
                                        id="feedback__content"
                                        placeholder="请输入你对网站的建议"
                                        type="textarea"
                                        :rows="6"
                                        resize="none"
                                        v-model="feedback.content">
                                    </el-input>
                                    <el-button type="primary" @click="feedback_add">确定</el-button>
                                </div>
                            </div>
                            <div class="links card">
                                <el-dialog
                                title="申请友链"
                                :visible.sync="friends_links_dialog"
                                width="30%">
                                <div class="dialog_content">
                                    <div>
                                        <label for="site_add__title">网站标题</label>
                                        <el-input
                                            id="site_add__title"
                                            placeholder="请输入你的网站标题"
                                            v-model="site.title">
                                        </el-input>
                                    </div>
                                    <div>
                                        <label for="site_add__href">网站链接</label>
                                        <el-input
                                            id="site_add__href"
                                            placeholder="请输入你的网站链接"
                                            v-model="site.href">
                                        </el-input>
                                    </div>
                                    <div>
                                        <label for="site_add__abstract">网站描述</label>
                                        <el-input
                                            id="site_add__abstract"
                                            placeholder="请输入你的网站描述"
                                            type='textarea'
                                            :rows="4"
                                            resize="none"
                                            v-model="site.abstract">
                                        </el-input>
                                    </div>
                                    <div>
                                        <label for="site_add__icon_href">网站图标</label>
                                        <div style="display: flex;">
                                            <el-input
                                                id="site_add__icon_href"
                                                placeholder="请输入你的网站图标链接"
                                                class="icon_href"
                                                v-model="site.icon_href">
                                            </el-input>
                                             <div class="icon_img">
                                                 <img :src="site.icon_href" alt="">
                                             </div>
                                        </div>
                                    </div>
                                </div>
                                <span slot="footer" class="dialog-footer">
                                    <el-button @click="friends_links_dialog = false">取消</el-button>
                                    <el-button @click="friend_link_add">确定</el-button>
                                </span>
                            </el-dialog>
                                <div class="title">
                                    <h2>友情链接</h2>
                                    <div><a href="javascript:void(0)" @click="friends_links_dialog = true">[申请入口]</a></div>
                                </div>
                                <div class="body">
                                    <ul>
                                        {% for link in link_list %}
                                        <li>
                                            <a href="{{ link.href }}" target="_blank">{{ link.title }}</a>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endblock main %}
            </main>
            <footer>
                <div class="left">
                    <p class="thank">Thank For</p>
                    <p class="site_info">
                        <span><img src="/static/my/img/footer/tencent.png" alt="">腾讯云服务器</span>
                        <span><img src="/static/my/img/footer/tencent.png" alt="">腾讯云SSL证书</span>
                        <span><img src="/static/my/img/footer/qiniu.png" alt="">七牛云存储</span>
                    </p>
                    <p class="version">
                        <span>Version</span>
                        <span>4.0.0</span>
                    </p>
                    <p>建站日期: 2021-12-29</p>
                    <p class="beian">
                        <a href="">
                            <img src="/static/my/img/footer/badges.png" alt="">
                            备案号:2121212121
                        </a>
                    </p>
                </div>

                <div class="right">
                    <div class="contact">
                        <div>
                            <img class="svg" src="/static/my/img/footer/qq_icon.svg" alt="">
                            <img class="qq" src="/static/my/img/footer/qq.png" alt="">
                        </div>

                    </div>
                    <p>2411358676@qq.com</p>
                </div>
            </footer>
            </el-scrollbar>
        </div>
        <script src="/static/axios/axios.min.js"></script>
        <script >
            axios.interceptors.request.use(
                request=>{
                    if (request.method !== 'get'){
                        let csrftoken = document.querySelector('input[name="csrfmiddlewaretoken"]').value
                        request.headers[ 'X-CSRFToken'] = csrftoken
                    }
                    return request
                })
                axios.interceptors.response.use(
                    response=>{
                    return response.data
                })
            /*  动态导航选中
                function dynamic_navigation(){
                    let a_list = document.querySelectorAll('#dynamic_nav>a')
                    let path = location.pathname
                    for(const a of a_list){
                        let a_href = a.getAttribute('href')
                        if(a_href === path || a_href + '/' === path){
                            a.classList.add('active')
                        }
                    }
                }
                */
            new Vue({
                el: '#app',
                delimiters: [
                    "[[", "]]"
                ],
                data: {
                    theme: 'light',//默认主题
                    this_category: 'qianduan',
                    comment_content: '',
                    isShowSlider: false,
                    slide_list:[],
                    slide_text:'显示悬浮目录',
                    search_key:'',
                    news_list:[],
                    news_init:[
                        {name: '微博', id: 'KqndgxeLl9', url: 'https://file.ipadown.com/tophub/assets/imges/media/s.weibo.com.png_50x50.png'},
                        {name: '知乎', id: 'mproPpoq6O', url: 'https://file.ipadown.com/tophub/assets/imges/media/s.weibo.com.png_50x50.png'},
                        {name: '微信', id: 'WnBe01o371', url: 'https://file.ipadown.com/tophub/assets/imges/media/s.weibo.com.png_50x50.png'},
                    ],
                    news_active:'微博',
                    news_active_url:'https://file.ipadown.com/tophub/assets/imges/media/s.weibo.com.png_50x50.png',
                    site_title:{
                        title:''
                    },
                    site_dialogVisible: false,
                    site_tag_add:false,
                    site_tab_tag: '教程',
                    site_list:[],
                    site_add_dialogVisible:false,
                    site:{
                        title:'',
                        abstract:'',
                        href:'',
                        icon_href:'',
                        tag: [],
                    },
                    site_add_edit:'',
                    site_order:'create_date',
                    friends_links_dialog: false,
                    feedback:{
                        email: '',
                        content: '',
                    },
                    edit_cover_dialog:false,
                    edit_cover:{
                        nid: '',
                        aid: '',
                    },
                },
                created() {
                    this.init_theme()
                    let path = location.pathname
                    if(path.indexOf('article') !== -1){
                        this.init_slider()

                    }
                    if(path.indexOf('search') !== -1){
                        this.init_search_key()
                    }
                    if(path.indexOf('news') !== -1){
                        this.news_init_method(0)
                    }
                    if(path.indexOf('sites') !== -1){
                        this.init_site()
                    }
                    if(path.indexOf('/') !== -1){
                        this.news_init_method(1)
                    }

                    setTimeout(() =>{
                        this.get_sidebar()
                        this.code_copy()
                    },200)
                },
                mounted(){
                    this.keyDown()
                    let path =location.pathname
                    if(path.indexOf('search') === -1){
                        setTimeout(() =>{
                            this.init_scrollbar()
                        },100)

                    }
                },
                methods: {
                    // 初始化滚动条
                    init_scrollbar(){
                        let slider = document.querySelector('.slider_bar')
                        let nav = document.querySelector('.nav_bg')
                        let top1 = 0
                        let path = location.pathname
                        let bar = this.$refs.scrollbar.wrap
                        let old_url = localStorage.getItem('current_url')
                        let new_url = location.href
                        if (path.indexOf('article') !== -1 || path.indexOf('about') !== -1){
                            top1 = $(slider).offset().top - 80
                        }
                        if(old_url === new_url){
                            let top = localStorage.getItem('current_top')
                            localStorage.setItem('current_top', '0')
                            let el_bar = document.querySelector('.el-scrollbar__warp')
                            $(el_bar).animate({scrollTop:top}, 0)
                        }

                        bar.onscroll = () =>{
                            let top = bar.scrollTop
                            if(top >= 200){
                                nav.classList.add('show')
                            }else {
                                nav.classList.remove('show')
                            }
                            if(slider){
                                if(top >= top1){
                                    slider.classList.add('fixed')
                                }else {
                                    slider.classList.remove('fixed')
                                }
                            }
                        }
                    },

                    //
                    keyDown(){
                        let el_bar = document.querySelector('.el_scrollbar__wrap')
                        document.onkeydown = (e) =>{
                            let e1 = e || event || window.event || arguments.callee.caller.arguments[0]
                            let top = el_bar.scrollTop
                            if(e1.code == 'ArrowDown'){
                                $(el_bar).animate({scrollTop:top+20},0)
                            }else if(e1.code == 'ArrowUp'){
                                $(el_bar).animate({scrollTop:top-20},0)
                            }
                        }

                    },
                    //初始化主题信息
                    init_theme() {
                        let theme = localStorage.getItem('theme')
                        if (theme) {
                            this.theme = theme
                        }
                    },

                    //设置主题
                    setTheme(themeName) {
                        this.theme = themeName
                        //持久化存储
                        localStorage.setItem('theme', themeName)
                    },
                    //选择分类
                    switch_article_category(categoryName) {
                        this.this_category = categoryName
                    },
                    //发布评论
                    add_comment(nid) {
                        axios.post(`/api/article/comment/${nid}/`, {content: this.comment_content}).then(res => {
                            if (res.code) {
                                if (res.self) {
                                    this.$refs[`comment_${res.self}`].focus()
                                }
                                this.$message.error(res.msg)
                                return
                            }
                            this.$message.success(res.msg)
                            setTimeout(() => {
                                location.reload()
                            }, 500)
                        })
                    },
                    // 将被评论人的名字写到输入框
                    set_sub_placeholder(div, username, cid) {
                        $(div).find('textarea').attr('placeholder', `@${username}`)
                        $(div).find('textarea').attr('cid', cid)
                    },
                    //展示子评论列表
                    show_sub_comment_list(e, username, cid) {
                        let div = $(e.target).parent().parent().next()
                        $(div).slideToggle()
                        this.set_sub_placeholder(div, username, cid)
                    },
                    //子评论回复显示
                    sub_comment_set_placeholder(e, username, cid) {
                        let div = $(e.target).parents('.sub_comment_list')
                        this.set_sub_placeholder(div, username, cid)
                    },
                    //发布子评论
                    add_sub_comment(e, nid) {
                        // nid文章ID cid 评论id
                        axios.post(`/api/article/comment/${nid}/`, {
                            content: $(e.target).prev().val(),
                            pid: $(e.target).prev().attr('cid')
                        }).then(res => {
                            if (res.code) {
                                if (res.self) {
                                    this.$refs[`comment_${res.self}`].focus()
                                }
                                this.$message.error(res.msg)
                                return
                            }
                            this.$message.success(res.msg)
                            setTimeout(() => {
                                location.reload()
                            }, 500)
                        })
                    },
                    // 删除子评论
                    delete_sub_comment(nid, aid, root_comment_id){
                        this.$confirm('此操作将永久删除该评论, 是否继续?', '提示', {
                            confirmButtonText: '确定',
                            cancelButtonText: '取消',
                            type: 'warning'
                            }).then(() => {
                                axios.delete(`/api/article/comment/${nid}/`, {data: {
                                    aid,
                                    pid: root_comment_id,
                                    }}).then(res => {
                                    if(res.code){
                                        this.$message.error(res.msg)
                                        return
                                    }
                                    this.$message.success(res.msg)
                                    setTimeout(() =>{
                                        location.reload()
                                    },500)
                                })
                            }).catch(() => {
                                this.$message({
                                type: 'info',
                                message: '取消删除'
                            });
                        });

                    },
                    // 评论点赞
                    comment_digg(nid){
                        axios.post(`/api/comment/digg/${nid}/`).then(res =>{
                            if(res.code){
                                this.$message.error(res.msg)
                                return
                            }
                            e.target.innerHTML = `点赞（${res.data}）`
                            this.$message.success(res.msg)
                        })
                    },
                    // 文章点赞
                    article_digg(e, nid){
                        let dom = e.target
                        axios.post(`/api/article/digg/${nid}/`).then(res =>{
                            if(res.code){
                                this.$message.error(res.msg)
                                return
                            }
                            $(dom).next().text(res.data)
                            this.$message.success(res.msg)
                        })
                        dom.classList.add('show')
                        let timer = null
                        timer = setTimeout(() => {
                            dom.classList.remove('show')
                        },1000)
                    },
                    // 文章收藏
                    article_collects(e, nid){
                        let dom = e.target
                        axios.post(`/api/article/collects/${nid}/`).then(res =>{
                            if(res.code){
                                this.$message.error(res.msg)
                                return
                            }
                            this.$message.success(res.msg)
                            $(dom).next().text(res.data)
                            if(res.isCollects){
                                dom.classList.add('show')
                                return
                            }
                            dom.classList.remove('show')
                        })
                    },
                    // 回到顶部
                    go_to_top(){
                        $('html, body').animate({
                            scrollTop: 0
                        }, 1000)
                    },
                    //
                    init_slider(){
                        let flag = localStorage.getItem('isShowSlider')
                        setTimeout(() =>{
                            let box = document.querySelectorAll('.el-scrollbar__view')[1]
                            console.log(box)
                            let height = box.offsetHeight
                            if(height > 500){
                                height = 500
                            }else if(height === 0){
                                height = 200
                            }
                            document.getElementById('el-scrollbar').style.height = height + 'px'
                        },300)
                        if(flag){
                            flag = eval(flag)
                            if(flag){
                                this.isShowSplider=flag
                                this.$nextTick(() =>{
                                    this.sliderChange(flag)
                                })
                            }
                            return
                        }
                    },
                    // 浮动目录是否显示
                    sliderChange(val){
                        let dom = this.$refs.slider
                        localStorage.setItem('isShowSlider', val)
                        if(val){
                            dom.classList.add('show')
                            this.slide_text = '关闭悬浮目录'
                            return
                        }
                        dom.classList.remove('show')
                        this.slide_text = '显示悬浮目录'
                    },
                    // 悬浮目录
                    get_sidebar(){
                        let content = $('#article_content')
                        let h_list= content.children('h1,h2,h3,h4')
                        let lis=[]
                        for(let i = 0;i<h_list.length;i++){
                            let c = h_list[i].innerText
                            let tagName = h_list[i].tagName
                            let tagId = h_list[i].id
                            let ele = {
                                tagName,
                                c,
                                pos:'#' + tagId
                            }
                            lis.push(ele)
                        }
                        lis.push({
                            tagName: 'H1',
                            c:'去评论吧！',
                            pos: '.comment_submit'
                        })
                        this.slide_list = lis
                    },
                    //
                    go_side_bar(selector, e){
                        $('.slider_bar .body>p').css('color','')
                        e.target.style.color='#ff9800'
                        let box = $(selector)
                        let pos = box.offset()
                        pos.top = pos.top - 80
                        $('html,body').animate({scrollTop: pos.top}, 600)
                    },

                    // 代码一键复制
                    code_copy(){
                        $('pre').each(function (){
                            let copy = $('<i title="copy" class="el-icon-document-copy code-copy"></i>')
                            $(this).append(copy)
                        })
                        $('pre i.code-copy').click(e =>{
                            let text_list = $(e.target).prev().find('code')
                            let text = ''
                            text_list.each(function (){
                              text += $(this).text() + '\n'
                            })
                            let element = $('<textarea>' + text + '</textarea>')
                            $('body').append(element)
                            element[0].select()
                            document.execCommand('Copy')
                            element.remove()
                            this.$message.success('复制成功')
                        })
                    },

                    //点击搜索
                    search(){
                        let box = document.querySelector('.search')
                        if(! box.classList.contains('show_search')){
                            box.classList.add('show_search')
                            return
                        }
                        if(!this.search_key){
                            box.classList.remove('show_search')
                            return;
                        }
                        window.open('/search/?key='+this.search_key+'&word=', name='_blank')
                    },

                    //初始化搜索词
                    init_search_key(){
                        let dom = document.querySelector('.search_key_input')
                        let key = dom.getAttribute('data')
                        this.search_key = key
                    },

                    // 获取热搜数据
                    get_new_list(id, name, url, flag, size){
                        if(name === this.news_active && !flag){
                            return
                        }
                        this.news_active = name
                        this.news_active_url = url
                        let data = {
                            id,
                        }
                        if(size){
                            data.size = size
                        }
                        axios.post('https://api.codelife.cc/api/top/list', data).then(res =>{
                            this.news_list = res.data
                        })
                    },

                    news_init_method(size ){
                        this.get_new_list('KqndgxeLl9', '微博','https://file.ipadown.com/tophub/assets/imges/media/s.weibo.com.png_50x50.png' ,true, 1)
                    },

                    //添加标签
                    site_add_edit_tag_method(nid){
                        axios.post('/api/site_tag/' + nid, this.site_title).then(res =>{
                            if(res.code){
                                this.$message.error(res.msg)
                                return
                            }
                            this.$message.success(res.msg)
                            location.reload()
                        })
                    },

                    //
                    site_add_tag(nid){
                        if(!nid){
                            this.site_add_edit_tag_method('')
                            return
                        }
                        this.site_add_edit_tag_method(nid + '/')
                    },

                    //
                    site_tag_edit_show(title, nid){
                        this.site_title.title = title
                        this.site_dialogVisible = true
                        this.site_tag_add = nid
                    },

                    //
                    site_tag_handleClos(done){
                        this.site_title.title = ''
                        this.site_dialogVisible = false
                        done()
                    },

                    //
                    site_tag_remove(e, nid){
                        this.$confirm('此操作将会删除标签是否继续?','提示',{
                            confirmButtonText: '确定',
                            cancelButtonText: '取消',
                            type: 'warning',
                        }).then(() =>{
                            axios.delete(`/api/site_tag/${nid}/`).then(res => {
                                if(res.code){
                                    this.$message.error(res.msg)
                                    return
                                }
                                $(e.target).remove()
                            })
                        }).catch(() =>{
                            this.$message({
                                type:'info',
                                message:'已删除该标签'
                            });
                        });
                    },

                    //
                    site_tag_tab_show(title){
                        this.site_tab_tag =  title
                        this.site_get_list(title, this.site_order)
                    },

                    site_get_list(title, order){
                        axios.get('/api/sites/',{
                        params : {
                            title,
                            order,
                        }
                        }).then(res =>{
                            this.site_list = res
                        })
                    },

                    init_site(){
                        this.site_get_list(this.site_tab_tag, this.site_order)
                    },

                    site_add(nid){
                        if(!nid){
                            axios.post('/api/sites/', this.site).then(res =>{
                            if(res.code){
                                this.$message.error(res.msg)
                                $(`#site_add__${res.self}`)[0].focus()
                                return
                            }
                            this.$message.success(res.msg)
                            this.site_add_dialogVisible = false
                            this.init_site()
                        })
                        }else {
                            axios.put(`/api/sites/${nid}/`, this.site).then(res =>{
                            if(res.code){
                                this.$message.error(res.msg)
                                $(`#site_add__${res.self}`)[0].focus()
                                return
                            }
                            this.$message.success(res.msg)
                            this.site_add_dialogVisible = false
                            this.init_site()
                        })
                        }

                    },

                    site_edit_show(item){
                        let tag = []
                        for (const itemElement of item.tags) {
                            tag.push(itemElement.nid)
                        }
                        this.site = {
                            title:item.title,
                            abstract:item.abstract,
                            href:item.href,
                            icon_href:item.icon_href,
                            tag,
                        }
                        this.site_add_edit = item.nid
                        this.site_add_dialogVisible = true
                    },

                    site_edit_close(done){
                        done()
                        this.site_add_edit = false
                        this.site = {
                            title:'',
                            abstract: '',
                            href:'',
                            icon_href: '',
                            tag: [],
                        }
                    },

                    site_remove(e, nid){
                        this.$confirm('此操作将会删除标签是否继续?','提示',{
                            confirmButtonText: '确定',
                            cancelButtonText: '取消',
                            type: 'warning',
                        }).then(() =>{
                            axios.delete(`/api/sites/${nid}/`).then(res => {
                                if(res.code){
                                    this.$message.error(res.msg)
                                    return
                                }
                                $(e.target).parent().parent().remove()
                            })
                        }).catch(() =>{
                            this.$message({
                                type:'info',
                                message:'已删除该标签'
                            });
                        });
                    },

                    //
                    site_order_method(order){
                        this.site_order = order
                        this.site_get_list(this.site_tab_tag, this.site_order)
                    },

                    //
                    site_digg(e, item){
                        axios.post(`/api/site_digg/${item.nid}/`).then(res=>{
                            if(res.code){
                                this.$message.error(res.msg)
                                return
                            }
                            this.$message.success(res.msg)
                            item.digg_count += 1
                            $(e.target).parent().addClass('show')
                            setTimeout(() =>{
                                $(e.target).parent().removeClass('show')
                            },2000)
                        })
                    },

                    //
                    site_coll(e, item){
                        axios.post(`/api/site_coll/${item.nid}/`).then(res=>{
                            if(res.code){
                                this.$message.error(res.msg)
                                return
                            }
                            this.$message.success(res.msg)
                            if(res.data === 1){
                                $(e.target).parent().addClass('show')
                            }else {
                                $(e.target).parent().removeClass('show')
                            }
                            item.collects_count += res.data
                        })
                    },

                    // 添加友链
                    friend_link_add(){
                        axios.post('/api/friends_links/', this.site).then(res =>{
                            if(res.code){
                                this.$message.error(res.msg)
                                $(`#site_add__${res.self}`)[0].focus()
                                return
                            }
                            this.$message.success(res.msg)
                            this.friends_links_dialog = false
                        })
                    },

                    // 用户建议
                    feedback_add(){
                        axios.post('/api/feedback/', this.feedback).then(res =>{
                        if(res.code){
                                this.$message.error(res.msg)
                                $(`#feedback__${res.self}`)[0].focus()
                                return
                            }
                            this.$message.success(res.msg)
                            this.feedback.content = ''
                        })
                    },

                    show_edit_cover(aid, nid){
                        this.edit_cover.aid = aid
                        this.edit_cover.nid = nid
                        this.edit_cover_dialog = true
                    },

                    edit_cover_method(aid){
                        let nid = this.edit_cover.nid
                        axios.post(`/api/article/cover/${aid}/`, {nid}).then(res => {
                            location.reload()
                        })
                    }
                }
            })
            let w = true;
            $('a').click(e =>{
                w = false
            })
            window.onbeforeunload = e =>{
                // 将滚动条位置写入url
                if(w){
                    let el_bar = document.querySelector('.sl_scrollbar__wrap')
                    let url = location.href
                    localStorage.setItem('top', el_bar.scrollTop)
                    localStorage.setItem('current_url', url)
                }
            }


        </script>
        {% block js %}
            <script>
                let menu_img = document.querySelectorAll('.dynamic_shuffl')
                let banner = document.getElementById('banner_box')
                let banner_time = Number(banner.getAttribute('banner_time'))
                let menu_length = menu_img.length
                let index = 0
                let timer = null;
                clearInterval(timer)
                timer = setInterval(() => {
                    index++
                    if (index === menu_length) {
                        index = 0
                    }
                    for (let i of menu_img) {
                        i.style.opacity = 0
                    }
                    menu_img[index].style.opacity = 1
                    if(!banner_time){
                        clearInterval(timer)
                    }
                }, banner_time*1000)
                let banner_slogan = document.getElementById('banner_slogan')
                let slogan_list = eval(banner_slogan.getAttribute('list'))
                let slogan_time = Number(banner_slogan.getAttribute('slogan_time'))

                let slogan_index = 0;
                let slogan_timer =null
                slogan_timer = setInterval(() =>{
                    slogan_index++
                    if (slogan_index === slogan_list.length){
                        slogan_index = 0
                    }
                    if(!slogan_time){
                        clearInterval(slogan_timer)
                    }else {
                        banner_slogan.innerText = slogan_list[slogan_index]
                    }

                },slogan_time*1000)
            </script>
        {% endblock %}
        {% block article_js %}
        {% endblock %}
    </body>
</html>